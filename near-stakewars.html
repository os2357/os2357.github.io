<html>
<head>
<title>Running a Near Shardnet Validator in Stakewars III | os2357</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Manrope&display=swap" rel="stylesheet">
<style type="text/css">
	body {
		font-family: 'Manrope', sans-serif;
		margin: 20px;
	}
	img {
		padding: 5px;
	}
	pre {
  		font-family: "Courier New", monospace;
}
</style>
</head>
<body>
<h1>Running a Near Shardnet Validator</h1>
<h3>Covering Stakewars-III Challenges 001-004</h3>
<div id="intro">
<p>Follow along to learn how to deploy a Near shardnet validator in the cloud.</p>
<small>
<ul>
	<li><a href="#">Intro</a></li>
	<li><a href="#pre">Prerequisites</a></li>
	<li><a href="#c1">Challenge 001</a></a></li>
	<li><a href="#c2">Challenge 002</a></li>
	<li><a href="#c3">Challenge 003</a></li>
	<li><a href="#c4">Challenge 004</a></li>
</ul>
</small>
</div>
<div id="pre">
<h2>Prerequisites</h2>
<p>My hosting provider of preference is <a href="https://hetzner.de">Hetzner</a>, whose cloud offerings we'll be using in this guide. <br />
For NEAR <a href="https://near.org/stakewars">Stakewars III</a>, I recommend using <strong>8 CPU</strong> cores, <strong>16 GB RAM</strong>, and <strong>200 GB+ disk space</strong>.</p>
<h3>Pricing</h3>
<p>A good example is <strong>CPX41</strong> (AMD) in Falkenstein (Germany) for € 0.0452 / hr, i.e. € 27.25 / mo.</p>
<h3>Create a new cloud instance</h3>
<img src="images/near/create-a-server.png" width="70%"> <br />
<p>Choose a location of choice, then 1. OS image: <strong>Ubuntu</strong>, 2. Type: <strong>Standard</strong>, 3. e.g. <strong>CPX41</strong>, 4. Volume: <strong>200 GB</strong>, 5. Networking: <strong>Public IPv4</strong>, <strong>Public IPv6</strong>. Add an <strong>SSH key</strong> to log in.</p>
</div>
<div id="c1">
<h2>Challenge 001</h2>
<p>To kick things off, it's time to create a brand new Near account on Shardnet. To do this, use the <a href="https://wallet.shardnet.near.org/">Shardnet Wallet</a>. <br />
Thanks to Near Wallet's user-friendliness, all you need to do is to click on <strong>Create Account</strong>.</p>
<img src="images/near/near-is-here.png" width="70%"> <br />
<p>Next, you can reserve your new <strong>account ID</strong>.
<img src="images/near/reserve-near-id.png" width="70%"> <br />
<br />
<strong>Handy Shardnet Links</strong>:
<ul>
	<li><a href="https://wallet.shardnet.near.org/">Wallet</a></li>
	<li><a href="https://explorer.shardnet.near.org/">Explorer</a></li>
</ul>

<p>Cool! Now let's set up NEAR CLI. <br /></p>
<pre>
sudo apt update && sudo apt upgrade -y
curl -sL https://deb.nodesource.com/setup_18.x | sudo -E bash - 
sudo apt install build-essential nodejs
PATH="$PATH"
sudo npm install -g near-cli</pre>

<p>Set Near testnet as persistent environment variables:</p>
<pre>
echo 'export NEAR_ENV=shardnet' >> ~/.bashrc
echo 'export NEAR_ENV=shardnet' >> ~/.bash_profile
source $HOME/.bash_profile
</pre>
<p>Test NEAR CLI by checking out its help page</p>
<pre>near --help</pre>

</div>
<div id="c2">
<h2>Challenge 002</h2>
<p>Challenge 2 is all about getting your validator node running. May the real fun part begin! <br />
Firstly, let's confirm that your machine's CPU supports AVX instructions which are required.</p>
<pre>
lscpu | grep -P '(?=.*avx )(?=.*sse4.2 )(?=.*cx16 )(?=.*popcnt )' > /dev/null \
&& echo "Supported" \
|| echo "Not supported"
</pre>

<p>If that went well, install dependencies</p>
<pre>
sudo apt install -y clang build-essential make git binutils-dev libcurl4-openssl-dev zlib1g-dev libdw-dev libiberty-dev cmake gcc g++ python docker.io protobuf-compiler libssl-dev pkg-config clang llvm cargo python3-pip
</pre>

<p>Set configuration</p>
<pre>
USER_BASE_BIN=$(python3 -m site --user-base)/bin
export PATH="$USER_BASE_BIN:$PATH"
</pre>

<p>Install Rust and cargo</p>
<pre>
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
source $HOME/.cargo/env
</pre>

<h3>Clone nearcore</h3>
<pre>
git clone https://github.com/near/nearcore
cd nearcore
git fetch
</pre>

<p>Check out to the required commit <a href="https://github.com/near/stakewars-iii/blob/main/commit.md"><strong>found here</strong></a> (e.g. 68bfa84ed1455f891032434d37ccad696e91e4f5), then</p>
<pre>
git checkout <commit>
</pre>

<p>You can now build nearcore via cargo build with the following flags</p>

<pre>
cargo build -p neard --release --features shardnet
</pre>

<p>This takes a little while, go get some coffee or tea. The binary path is target/release/neard. <br/>
NEAR node requires a working directory and configuration files. Generate the initial required working directory by running</p>
<pre>
./target/release/neard --home ~/.near init --chain-id shardnet --download-genesis
</pre>

<p>Replace the config file</p>
<pre>
rm ~/.near/config.json
wget -O ~/.near/config.json https://s3-us-west-1.amazonaws.com/build.nearprotocol.com/nearcore-deploy/shardnet/config.json
</pre>

<h3>Run the Node!</h3>
<pre>
cd ~/nearcore
./target/release/neard --home ~/.near run
</pre>

Finally, activate your node as a validator by authorizing your wallet. This is because a full access key needs to be installed locally to be able to sign transactions via NEAR-CLI.

<pre>
near login
</pre>

<p>Follow the instructions and copy the generated link into your browser, which will allow you to grant access to Near CLI. Enter your account name and press enter.</p>

<h3>Create your Pool</h3>

<p>Let's get going by generating a new key for your pool.</p>
<pre>
near generate-key <pool_id>
</pre>

<p>Note: <pool_id> ---> xx.factory.shardnet.near WHERE xx is you pool name. <br />
Copy the file generated to shardnet folder: Make sure to replace <pool_id> by your accountId.</p>

<pre>
cp ~/.near-credentials/shardnet/YOUR_WALLET.json ~/.near/validator_key.json
</pre>

<p>Make the following changes: <br />
1. Edit "account_id" to xx.factory.shardnet.near, where xx is your PoolName <br />
2. Change "private_key" to "secret_key" <br />
Note: The account_id must match the staking pool contract name or you will not be able to sign blocks.</p>

<p>The file's content should look similar to the following</p>
<pre>
{
  "account_id": "xx.factory.shardnet.near",
  "public_key": "ed25519:HeaBJ3xLgvZacQWmEctTeUqyfSU4SDEnEwckWxd92W2G",
  "secret_key": "ed25519:****"
}
</pre>

<p>Awesome. You can now start your Near shardnet validator node</p>
<pre>
target/release/neard run
</pre>

</div>
<div id="c3">
<h2>Challenge 003</h2>
</div>
<div id="c4">
<h2>Challenge 004</h2>
</div>
</body>
</html>